name: Auto Generate Daily AI Post

on:
  schedule:
    - cron: '0 9 * * *'   # 09:00 UTC (~16:00 VN)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (with credentials for push)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          # n·∫øu c√≥ requirements.txt, b·ªè d√≤ng comment b√™n d∆∞·ªõi:
          # if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # --- Vi·∫øt includes (ad + analytics) tr·ª±c ti·∫øp t·ª´ bi·∫øn m√¥i tr∆∞·ªùng ---
      - name: Create includes (ad + analytics)
        env:
          GA_ID: "G-DNS1L38XQ9"
          AD_SNIPPET: '<script async data-cfasync="false" src="//pl27914938.effectivegatecpm.com/e8bf08180bd7c986609bff7085685830/invoke.js"></script><div id="container-e8bf08180bd7c986609bff7085685830"></div>'
        run: |
          mkdir -p _includes
          # analytics include (Google Analytics gtag)
          cat > _includes/analytics.html <<'GA_HTML'
<script async src="https://www.googletagmanager.com/gtag/js?id=${GA_ID}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '${GA_ID}');
</script>
GA_HTML
          # ad include (raw snippet)
          cat > _includes/ad.html <<'AD_HTML'
${AD_SNIPPET}
AD_HTML

      - name: Run generator
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}    # n·∫øu d√πng OpenAI
          SITE_DOMAIN: "botdefi.io"
          GA_ID: "G-DNS1L38XQ9"
          AD_SNIPPET: '<script async data-cfasync="false" src="//pl27914938.effectivegatecpm.com/e8bf08180bd7c986609bff7085685830/invoke.js"></script><div id="container-e8bf08180bd7c986609bff7085685830"></div>'
        run: |
          # ch·∫°y generator python ‚Äî script ph·∫£i ghi _posts/YYYY-MM-DD-slug.md
          python auto_generate.py

      - name: Commit generated files
        run: |
          git config user.name "Auto Bot"
          git config user.email "auto@users.noreply.github.com"
          # th√™m _posts v√† _includes (trong tr∆∞·ªùng h·ª£p includes m·ªõi c·∫ßn commit)
          git add _posts _includes || true
          if git diff --cached --quiet; then
            echo "No new files to commit"
          else
            git commit -m "üì∞ Auto post $(date -u +'%Y-%m-%d %H:%M UTC')" || echo "commit failed or nothing to commit"
            git push origin HEAD:main
          fi

      - name: Ping Google sitemap
        env:
          DOMAIN: botdefi.io
        run: |
          echo "Pinging https://www.google.com/ping?sitemap=https://$DOMAIN/sitemap.xml"
          curl -s "https://www.google.com/ping?sitemap=https://$DOMAIN/sitemap.xml" || true
